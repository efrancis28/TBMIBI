Script,Software,Description,Packages,Input,Output,Figures
TBMIBIrunFlowSOMv2.R,R 3.6.2,Iteratively runs FlowSOM on TB single cell data,"flowCore, ggplot2, gplots, RColorBrewer, reshape2, FlowSOM, plyr, dplyr, viridis",allsamples_dataCS3px_annotated.csv,granA_cellpheno_CS-asinh-norm.csv,"Fig. 1, Extended Data Fig. 2"
TBMIBIcellFreq.R,R 3.6.2,Quantifies lineage and immune cell frequency across FOVs. Plots various visualizations of cell stats.,"dplyr, viridis, ggplot2, forcats, reshape2, tidyr",granA_cellpheno_CS-asinh-norm_revised.csv,"immlineage_freqs.csv, total_freqs.csv, lineage_freqs.csv, immune_cell_freqs.csv, lineage_cell_totals.csv, immune_cell_totals.csv","Fig. 1, Extended Data Fig. 2, Extended Data Fig. 5"
TBMIBIcellFreqCorrelation.R,R 3.6.2,Runs correlation analysis based on immune cell frequency in TB FOVs.,"factoextra, data.table, ggplot2, PerformanceAnalytics, psych, Hmisc, corrplot, gplots, colorspace",immune_cell_freqs.csv,NA,"Fig. 1, Fig. 2, Extended Data Fig. 2"
TBMIBIdetermineMarkerCutoff.R,R 3.6.2,Uses the MetaCyto silhouette scanning approach to determine marker positivity thresholds from normalized expression data.,"Hmisc, MetaCyto, tidyr, plyr, ggplot2",granA_cellpheno_CS-asinh-norm.csv,markerThresholds.csv,Extended Data Fig. 1
TBMIBIcellCountChiSquare.R,R 3.6.2,Runs a chi-square analysis in TB FOVs between all cell types.,"reshape2, dplyr, tidyverse, broom, gplots, RColorBrewer","immune_cell_freqs.csv, lineage_freqs.csv",NA,Extended Data Fig. 2
TBMIBICD4CD8ratio.R,R 3.6.2,Calculates the CD4:CD8 ratio for all sarcoid and TB FOVs. For the TB FOVs it analyses differences based on cluster.,"ggplot2, dplyr, forcats, tidyverse, reshape2, ggpubr, ggsignif, ggpmisc",immune_cell_freqs.csv,CD4CD8ratio.csv,"Fig. 1, Fig. 5"
TBMIBIheatmap.R,R 3.6.2,Visualizes the mean expression of all clustering markers across all cell susbets in TB and sarcoid,"dplyr, gplots, viridis",granA_cellpheno_CS-asinh-norm_revised.csv,NA,Fig. 1
TBMIBInetworkVis.R,R 3.6.2,"Visualizes positive protein interactions as an undirected , weighted network with community detection",igraph,pooledTB.csv,NA,Fig. 2
MIBIQuantifySpatialOrganizationMarkerExpression.m,MATLAB 2019b,"Runs spatial enrichment analysis from Keren et al, Cell 2018 ",NA,"granA_cellpheno_CS-asinh-norm_matlab_revised.csv, markerThresholds.csv, cellDistances.mat (from MIBICreateDistanceMatrixBetweenCells.m)",spatialAnalysis.mat (contains z-scores and p-values for interactions),Extended Data Fig. 3
MIBICreateDistanceMatrixBetweenCells.m,MATLAB 2019b,"For each FOV, creates a cell x cell matrix with pairwise centroid distances",NA,Segmentation mask with objects labeled,cellDistances.mat,Extended Data Fig. 3
MIBIpooledSpatialOrganizationAnalysis.m,MATLAB 2019b,Summarizes enrichments for a subset of FOVs with average z-score and determining % FOVs significant for interactions,NA,spatialAnalysis.mat (from MIBIQuantifySpatialOrganizationMarkerExpression.m),spatialAnalysiPooled.mat (average Z scores and percent positive for interactions pooled for a subset of FOVs),Extended Data Fig. 3
MIBIPlotCellPopulationsForCohort.m,MATLAB 2019b,Colors segmentation mask by cell phenotype,NA,"granA_cellpheno_CS-asinh-norm_matlab_revised.csv, segmentation mask, colorkey_R.csv","cell_type.tif, lin_type.tif",All CPMs
MIBIPlotCellTopicsForCohort.m,MATLAB 2019b,Colors segmentation mask by the maximum microenvironment (topic) assignment,NA,"all_TB_topic_annotation.csv, colorkey_topics.csv, topic_numkey.csv, segmentation mask",topic_overlay.tif,Extended Data Fig. 3
MIBIPlotCellTopicGradientsForCohort.m,MATLAB 2019b,Colors segmentation mask by the maximum microenvironment (topic) assignment with a gradient of probability for a selected FOV(s) and microenvironment,NA,"all_TB_topic_annotation.csv, segmentation mask",topic(number)_gradient.tif,All MaxPMs
TBMIBIquantifyCellTypeLoadingsAcrossMEs.R,R 3.6.2,Determines mean probability per cell type and per ME. Visualizes as a heatmap.,"dplyr, gplots, pals, colorspace",all_TB_topic_annotation.csv,NA,Fig. 2
TBMIBIquantifyExpressionAcrossAllMEs.R,R 3.6.2,Plots expression of functional markers across all MEs based on cell assignment and weighted expression from probability for all MEs.,"plyr, dplyr, pals, colorspace, gplots",all_TB_topic_annotation.csv,NA,Fig. 2
TBMIBIdistributionofMyeloidCoreCellsAcrossMEs.R,R 3.6.2,Plots the frequency of cells in the myeloid core across all Mess.,"ggplot2, dplyr","celldata_region_annotated.csv, all_TB_topic_annotation.csv",NA,Extended Data Fig. 3
MIBIannotateCellsinGranulomaZones.m,MATLAB 2019b,"Assigns each cell to the myeloid zone, peripheral zone, or other",NA,"regionmask.mat (from MIBIdefineMyeloidAndPeripheralZone.m), segmentation mask, granA_cellpheno_CS-asinh-norm_matlab_revised.csv",granA_cellpheno_CS-asinh-norm_matlab_revised.csv,Extended Data Fig. 3
MIBIdefineMyeloidAndPeripheralZone.m,MATLAB 2019b,Produces a mask of the myeloid core and peripheral zone.,NA,mask from summed myeloid channel,regionmask.mat,Extended Data Fig. 3
TBMIBImicroenvironmentFrequencyClustering.R,R 3.6.2,Clusters FOVs by ME frequency. Runs a correlation clustering analysis.,"reshape2, corrplot, psych, gplots, ggplot2, colorspace, GMD",all_TB_topic_annotation.csv,NA,"Fig. 2, Extended Data Fig. 3"
TBMIBIexamineMETissueType.R,R 3.6.2,Summarizes the frequency of each ME between tissues of different types,"ggpubr, dplyr, ggplot2, reshape2, forcats",all_TB_topic_annotation.csv,NA,Extended Data Fig. 3
TBMIBIrunPCAonMeanMELoadings.R,R 3.6.2,Runs PCA on all FOVs based on mean ME probability,"ggplot2, ggrepel, factoextra, ",all_TB_topic_annotation.csv,NA,Extended Data Fig. 3
TBMIBIquantifyCellAbundanceinMEPerPatient.R,R 3.6.2,"For each FOV, plots a stacked bar of the counts of cell phenotypes per ME","ggplot2, dplyr","all_TB_topic_annotation.csv, colorkey_R.csv",NA,Extended Data Fig. 3
TBMIBIrunUMAP.R,R 3.6.2,Runs UMAP on the myeloid cell compartment,"umap, ggplot22, RColorBrewer, dplyr, ggrastr","granA_cellpheno_CS-asinh-norm_revised.csv, colorkey_R.csv",NA,Fig. 3
TBMIBIexprsViolinPlot.R,R 3.6.2,Plots violins of IDO1 and PD-L1 expression across major myeloid cell subsets,"ggplot2, dplyr, forcats","granA_cellpheno_CS-asinh-norm_revised.csv, colorkey_R.csv",NA,Fig. 3
TBMIBIplotCorr.R,R 3.6.2,Plots IDO1 v PD-L1 expression in single cells. Determines Pearson correlation for various subsets of the data.,ggplot2,granA_cellpheno_CS-asinh-norm_revised.csv,NA,"Fig.3, Extended Data Fig. 4"
TBMIBI_SuppCells_IDO1PDL1.R,R 3.6.2,Determines the frequency (bulk) of neutrophils and eptihelial cells that are PDL1+ or IDO1+ and plots as a barplot,ggplot2,granA_cellpheno_CS-asinh-norm_revised.csv,NA,Extended Data Fig. 4
TBMIBIgiantcellIDOPDL1.R,R 3.6.2,Determines the frequency (bulk) of giant cells that are PDL1+ or IDO1+ and plots as a barplot,ggplot2,granA_cellpheno_CS-asinh-norm_revised.csv,NA,Fig. 3
TBMIBIquantifyPDL1PosFreqAcrossMEsAndCells.R,R 3.6.2,"Determine the % positivity among myeloid cells for PD-L1 across all MEs and FOVs. Plots the mean and SE as a barplot for total myeloid and each ME. Next it produces the plot above for specific cell type examples. Lastly, it produces a heatmap of the frequency (bulk) of PD-L1+ cells per cell subset and per ME.","ggpubr, ggplot2, colorspace, forcats, dplyr, tibble, reshape2, gplots",all_TB_topic_annotation.csv,NA,"Fig. 3, Extended Data Fig. 4"
TBMIBIquantifyIDO1PosFreqAcrossMEsAndCells.R,R 3.6.2,"Determine the % positivity among myeloid cells for IDO1 across all MEs and FOVs. Plots the mean and SE as a barplot for total myeloid and each ME. Next it produces the plot above for specific cell type examples. Lastly, it produces a heatmap of the frequency (bulk) of IDO1+ cells per cell subset and per ME.","ggpubr, ggplot2, colorspace, forcats, dplyr, tibble, reshape2, gplots",all_TB_topic_annotation.csv,NA,"Fig. 3, Extended Data Fig. 4"
TBMIBIcellfreq_IDO1_PDL1.R,R 3.6.2,Determines the frequency and count of PD-L1+ and IDO1+ cells per FOV and per cell subset. Plots as a stacked bar plot.,"dplyr, ggplot2, forcats, reshape2, tidyr","granA_cellpheno_CS-asinh-norm_revised.csv, colorkey_R.csv",NA,Extended Data Fig. 4
TBMIBIpercentPosIDO1PDL1AcrossCohorts.R,R 3.6.2,Determines the frequency of IDO1+ and PD-L1+ cells across all FOVs. Groups them by specimen type and plots the distributions as boxplots with rank sum p-values. ,"ggplot2, forcats, dplyr, tidyverse, ggpubr",granA_cellpheno_CS-asinh-norm_revised.csv,NA,Extended Data Fig. 4
TBMIBIquantifyPD1TcellsAcrossTopics.R,R 3.6.2,Determines the frequency of PD-1+ lymphocytes per topic in bulk and visualizes as a barplot.,"ggplot2, forcats, dplyr",all_TB_topic_annotation.csv,NA,Extended Data Fig. 4
TBMIBIquantifyLymphMEEnrichments.R,R 3.6.2,"Calculates the frequency of all lymphocytes per FOV per ME. Also determines the baseline frequency of immune cells, all immune cells, and CD4 T cells (for Tregs). Next calculates the relative enrichment of subsets across MEs compared to different baselines.","ggpubr, ggplot2, dplyr, forcats, splitstackshape, reshape2",all_TB_topic_annotation.csv,NA,Fig. 4
TBMIBIpercentKi67pos.R,R 3.6.2,Calculates frequency of Ki67+ per all lymphocyte subsets,"ggplot2, dplyr, forcats, tidyverse, ggpubr, ggsignif, exactRankTests","granA_cellpheno_CS-asinh-norm_revised.csv, colorkey_R.csv",NA,Fig. 4
TBMIBIcomparePDL1PD1FreqTNBC.R,R 3.6.2,"Assesses frequency of PD-1+, Lag3+, and PD-L1+ cells in TB, sarcoid, immune controls, and TNBC","dplyr, reshape2, ggplot2","allsamples_dataCS3px_annotated.csv, granA_cellpheno_CS-asinh-norm_revised.csv, cellData.csv ",NA,"Fig. 4, Fig. 5"
TBMIBIcalculateDiversityIndex.R,R 3.6.2,Determines the Shannon and Simpson Diversity Index between TB and sarcoid FOVs based on cell type abundances,"factoextra, ggplot2, ggpubr, dplyr, vegan","immune_cell_freqs.csv, lineage_freqs.csv",sarcvTB_counts_diversity.csv,Extended Data Fig. 5
TBMIBIcompareCellTypeAbundancesSarcvTB.R,R 3.6.2,Compares relative frequency of cell types between TB and sarcoid FOVs. Plots as paired boxplots with rank sum p-values. ,"ggplot2, dplyr, tidyverse, ggpubr",sarcvTB_counts_diversity.csv,NA,"Fig. 5, Extended Data Fig. 5"
TBMIBIcellfreq_IDO1_PDL1_Sarcoid.R,R 3.6.2,Determines the frequency of PD-L1+ and IDO1+ cells per subset and FOV. Plots results as a stacked bar. ,"dplyr, ggplot2, forcats, reshape2, tidyr","granA_cellpheno_CS-asinh-norm_revised.csv, colorkey_R.csv",NA,Extended Data Fig. 5
TBMIBIpercentIDOPDL1pos.R,R 3.6.2,Determines the frequency of IDO1+ and PD-L1+ cells (of total) for all FOVs. Exports the stats and plots boxplots of sarcoid vs TB FOVs with rank sum p-values. ,"ggplot2, dplyr",granA_cellpheno_CS-asinh-norm_revised.csv,"IDOpos.csv, PDL1pos.csv",Fig. 5
TBMIBIplotGeneESProgression.R,R 3.6.2,Plots the effect size for all genes across clinical stages of TB.,"gplots, colorspace",ESprogression_profiles_allgenes.csv,NA,Fig. 6